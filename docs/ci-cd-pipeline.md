# Android CI/CD Pipeline Documentation

## Overview

The A la carte Android app uses GitHub Actions for automated builds and releases. The pipeline supports both pre-release builds for testing and production releases for distribution.

## 🏗️ Pipeline Architecture

### **Two-Track Build System**

```
feat/* or fix/* branch → PR → Pre-release Job → Debug APK
                                                    ├── Development API
                                                    ├── Debug keystore
                                                    └── Package: .debug suffix

master branch → Push → Release Job → Release APK (if version changed)
                                        ├── Production API
                                        ├── Release keystore
                                        └── Package: production
```

## ⚙️ Configuration Management

### **Environment Variables via .env Files**

The pipeline uses dotenv for configuration management instead of compile-time constants:

#### **Local Development:**
```bash
# .env (gitignored)
API_BASE_URL=https://alacarte-api-414358220433.northamerica-northeast1.run.app
GOOGLE_CLIENT_ID=414358220433-utddgtujirv58gt6g33kb7jei3shih27.apps.googleusercontent.com
APP_VERSION=1.0.0-dev
```

#### **CI/CD Pre-release:**
```bash
# Generated by workflow
API_BASE_URL=${DEVELOPMENT_API_URL}
GOOGLE_CLIENT_ID=${DEVELOPMENT_GOOGLE_CLIENT_ID}
APP_VERSION=${GITVERSION_FULLSEMVER}
```

#### **CI/CD Production:**
```bash
# Generated by workflow  
API_BASE_URL=${PRODUCTION_API_URL}
GOOGLE_CLIENT_ID=${PRODUCTION_GOOGLE_CLIENT_ID}
APP_VERSION=${GITVERSION_SEMVER}
```

### **Build Mode Detection**

The app uses Flutter's `kDebugMode` to automatically select the correct configuration:

```dart
// app_config.dart
static String get baseUrl {
  final url = dotenv.env['API_BASE_URL'];
  if (url == null || url.isEmpty) {
    throw Exception('API_BASE_URL environment variable is required but not set');
  }
  return url;
}
```

**Benefits:**
- Debug builds (`--debug`) use development configuration
- Release builds (`--release`) use production configuration
- No manual environment switching needed

## 🔐 GitHub Secrets & Variables Setup

### **Required Variables** (Repository → Settings → Secrets and Variables → Actions → Variables)

| Variable | Value | Usage |
|----------|-------|-------|
| `DEVELOPMENT_API_URL` | Development backend URL | Pre-release builds |
| `DEVELOPMENT_GOOGLE_CLIENT_ID` | Development OAuth client | Pre-release builds |
| `PRODUCTION_API_URL` | Production backend URL | Production builds |
| `PRODUCTION_GOOGLE_CLIENT_ID` | Production OAuth client | Production builds |

### **Required Secrets** (Repository → Settings → Secrets and Variables → Actions → Secrets)

| Secret | Value | Usage |
|--------|-------|-------|
| `KEYSTORE_BASE64` | Base64 encoded keystore | Production APK signing |
| `KEYSTORE_PASSWORD` | Keystore password | Production APK signing |
| `KEY_PASSWORD` | Key password | Production APK signing |
| `KEY_ALIAS` | `release` | Production APK signing |

### **Generating KEYSTORE_BASE64**

```bash
cd alacarte-client
base64 -i android/app/release-keystore.jks | tr -d '\n'
# Copy the output and paste as KEYSTORE_BASE64 secret
```

## 📱 Android Signing Strategy

### **Debug Builds (Pre-releases)**
- **Keystore**: Default Android debug keystore (`~/.android/debug.keystore`)
- **Certificate**: Automatic debug certificate
- **SHA-1**: Standard debug SHA-1 fingerprint
- **Package**: `com.alacarte.alc_client.debug`
- **Setup Required**: None - works automatically
- **Use Case**: Development, testing, QA

### **Release Builds (Production)**
- **Keystore**: Custom release keystore (`release-keystore.jks`)
- **Certificate**: Your production certificate
- **SHA-1**: Your production SHA-1 fingerprint
- **Package**: `com.alacarte.alc_client`
- **Setup Required**: Generate keystore + configure GitHub secrets
- **Use Case**: Production distribution

### **Why Two Different Packages?**

Using `applicationIdSuffix = ".debug"` for debug builds provides:
- **Side-by-side installation**: Debug and release versions can coexist
- **Environment isolation**: Separate OAuth clients for dev and prod
- **Clear identification**: Easy to distinguish which version is running
- **Testing safety**: Can't accidentally overwrite production app

## 🔄 Versioning with GitVersion

### **Semantic Versioning**

The pipeline uses GitVersion to automatically generate version numbers based on conventional commits:

```
master:
  - feat: Add rating feature → v1.1.0
  - fix: Fix OAuth bug → v1.1.1
  - feat!: Breaking change → v2.0.0

feat/android-workflow:
  - First commit → v1.2.0-feat-android-workflow.1
  - Second commit → v1.2.0-feat-android-workflow.2
```

### **GitVersion Configuration**

```yaml
# GitVersion.yml
mode: ContinuousDeployment
branches:
  master:
    mode: ContinuousDeployment
    increment: Patch
  feature:
    mode: ContinuousDeployment
    increment: Minor
next-version: 1.0.0
```

## 🚀 Workflow Execution

### **Pre-release Workflow**

1. **Create feature branch**: `git checkout -b feat/new-feature`
2. **Make changes and commit**: `git commit -m "feat: add new feature"`
3. **Push and create PR**: `git push origin feat/new-feature`
4. **Workflow triggers automatically**:
   - GitVersion calculates version
   - Creates `.env` with development config
   - Builds debug APK
   - Creates GitHub pre-release
   - Comments on PR with download links

### **Production Workflow**

1. **Merge PR to master**: Workflow triggers on push
2. **GitVersion checks version**:
   - If version changed → proceed with release
   - If no change → skip release
3. **Create Git tag**: `v1.2.3`
4. **Setup production keystore**
5. **Create `.env` with production config**
6. **Build signed release APK**
7. **Create GitHub release with APK**

## 📋 Release Artifacts

### **Pre-release GitHub Release**

Contains:
- **APK file**: `alacarte-v1.2.3-feat-android-workflow.1-debug.apk`
- **Changelog**: Commits in the PR
- **Installation instructions**
- **Signing information** (debug keystore)
- **API endpoint** (development)

### **Production GitHub Release**

Contains:
- **APK file**: `alacarte-v1.2.3-release.apk`  
- **Changelog**: Features, bug fixes, other changes since last version
- **Installation instructions**
- **Signing information** (release keystore)
- **APK size** and optimization details
- **Full changelog link** comparing versions

## 🧪 Testing the Pipeline

### **Test Pre-release Flow**

```bash
# Create and test a feature branch
git checkout -b feat/test-pipeline
echo "test" >> README.md
git add README.md
git commit -m "feat: test CI/CD pipeline"
git push origin feat/test-pipeline

# Open PR on GitHub
# Wait for workflow to complete
# Download and install APK from pre-release
# Verify it connects to development API
```

### **Test Production Flow**

```bash
# Merge PR to master
# Workflow automatically triggers
# Check if version bumped (should create release)
# Download and install production APK
# Verify it connects to production API
```

## 🔧 Troubleshooting

### **Common Issues**

#### **"Environment variable not set" error**
- **Cause**: GitHub variables/secrets not configured
- **Fix**: Add required variables in GitHub repository settings
- **Verification**: Check workflow logs for which variables are missing

#### **"Keystore not found" error**  
- **Cause**: KEYSTORE_BASE64 secret not set or invalid
- **Fix**: Regenerate base64 encoding and update secret
- **Verification**: Ensure no newlines in base64 string

#### **"Build failed - version solving"**
- **Cause**: Flutter version mismatch with pubspec.yaml
- **Fix**: Update `FLUTTER_VERSION` in workflow to match requirements
- **Current**: Flutter 3.27+ required for Dart SDK ^3.8.1

#### **OAuth ApiException error 10**
- **Cause**: Package name mismatch or missing SHA-1 in OAuth config
- **Fix**: Ensure debug builds use `com.alacarte.alc_client.debug` in OAuth client
- **Fix**: Add debug SHA-1 fingerprint to Google Cloud Console

### **Debugging Workflow**

Enable step debugging by checking workflow logs:
- Configuration step shows `.env` file contents
- Validation step confirms all variables are set
- Build logs show exact Flutter commands executed

## 📊 Performance Considerations

### **Build Caching**

The workflow uses GitHub Actions caching for:
- **Flutter dependencies**: Cached between builds
- **Gradle build cache**: Speeds up Android compilation
- **Build artifacts**: Reused when possible

### **Build Times**

Typical build times:
- **Pre-release (debug)**: ~3-5 minutes
- **Production (release)**: ~5-8 minutes (includes optimization)

## 🔒 Security Best Practices

### **Secrets Management**
- ✅ **Never commit** `.env` file
- ✅ **Never commit** keystore files
- ✅ **Use GitHub Secrets** for all sensitive data
- ✅ **Rotate keystores** periodically for production
- ✅ **Backup keystore** securely offline

### **Access Control**
- **GitHub Secrets**: Only accessible to repository admins
- **Workflow logs**: Secrets are masked automatically
- **Environment isolation**: Development and production fully separated

## 📚 Related Documentation

- **[Android Setup Guide](android-setup.md)** - Local Android development setup
- **[Authentication System](authentication-system.md)** - Google OAuth configuration
- **Main README** - General project documentation

## 🎯 Future Enhancements

### **Planned Improvements**
- **Automated testing**: Run unit/widget tests before builds
- **APK analysis**: Size tracking and optimization suggestions  
- **Fastlane integration**: Advanced deployment automation
- **Play Store upload**: Automated publishing to Google Play
- **Multi-flavor builds**: Staging, QA, production flavors
- **iOS pipeline**: Similar workflow for iOS builds
