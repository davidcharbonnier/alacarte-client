name: ğŸ“± Android CI/CD Pipeline

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [master]
    paths:
      - "**"
      - ".github/workflows/android-release.yml"
  push:
    branches: [master]
    paths:
      - "**"
      - ".github/workflows/android-release.yml"

env:
  FLUTTER_VERSION: "3.35.4"

jobs:
  # Pre-release job for PRs from feat/* and fix/* branches
  pre-release:
    if: github.event_name == 'pull_request' && (startsWith(github.head_ref, 'feat/') || startsWith(github.head_ref, 'fix/'))
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ Install GitVersion
        uses: gittools/actions/gitversion/setup@v0.10.2
        with:
          versionSpec: "5.x"

      - name: ğŸ”¢ Execute GitVersion
        uses: gittools/actions/gitversion/execute@v0.10.2
        id: gitversion

      - name: ğŸ“‹ Display GitVersion outputs
        run: |
          echo "ğŸ“Š GitVersion Results:"
          echo "  â€¢ SemVer: ${{ steps.gitversion.outputs.semVer }}"
          echo "  â€¢ FullSemVer: ${{ steps.gitversion.outputs.fullSemVer }}"
          echo "  â€¢ Major: ${{ steps.gitversion.outputs.major }}"
          echo "  â€¢ Minor: ${{ steps.gitversion.outputs.minor }}"
          echo "  â€¢ Patch: ${{ steps.gitversion.outputs.patch }}"
          echo "  â€¢ PreReleaseTag: ${{ steps.gitversion.outputs.preReleaseTag }}"
          echo "  â€¢ PreReleaseNumber: ${{ steps.gitversion.outputs.preReleaseNumber }}"

      - name: ğŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v3
        with:
          distribution: "zulu"
          java-version: "17"

      - name: ğŸ”§ Configure for Pre-release
        run: |
          echo "ğŸ”§ Creating .env configuration for pre-release..."
          
          # Validate required secrets/variables
          if [ -z "${{ vars.DEVELOPMENT_API_URL }}" ]; then
            echo "âŒ ERROR: DEVELOPMENT_API_URL variable is not set"
            echo "Please set this in Repository Settings â†’ Secrets and Variables â†’ Actions â†’ Variables"
            exit 1
          fi
          
          if [ -z "${{ vars.DEVELOPMENT_GOOGLE_CLIENT_ID }}" ]; then
            echo "âŒ ERROR: DEVELOPMENT_GOOGLE_CLIENT_ID variable is not set"
            echo "Please set this in Repository Settings â†’ Secrets and Variables â†’ Actions â†’ Variables"
            exit 1
          fi
          
          # Create .env file for CI/CD build
          cat << EOF > .env
          # CI/CD Generated .env file for pre-release
          API_BASE_URL=${{ vars.DEVELOPMENT_API_URL }}
          GOOGLE_CLIENT_ID=${{ vars.DEVELOPMENT_GOOGLE_CLIENT_ID }}
          APP_VERSION=${{ steps.gitversion.outputs.fullSemVer }}
          EOF
          
          echo "âœ… Created .env file with development configuration"
          echo "ğŸ“‹ .env contents:"
          cat .env

      - name: ğŸ“¦ Get Flutter dependencies
        run: flutter pub get

      - name: ğŸŒ Generate localizations
        run: flutter gen-l10n

      - name: âœ… Validate Configuration
        run: |
          echo "ğŸ“‹ Pre-release Configuration Summary:"
          echo "  â€¢ App Version: ${{ steps.gitversion.outputs.fullSemVer }}"
          echo "  â€¢ Build Number: ${{ github.run_number }}"
          echo "  â€¢ Environment: Debug (uses development API)"
          echo ""
          echo "ğŸ” Verifying .env file was created correctly:"
          if [ -f .env ]; then
            echo "  âœ… .env file exists"
            echo "  ğŸ“‹ Contents:"
            cat .env
          else
            echo "  âŒ .env file not found!"
            exit 1
          fi

      - name: ğŸ—ï¸ Build Debug APK
        run: |
          echo "ğŸ”¨ Building debug APK with default Android debug signing..."
          flutter build apk --debug \
            --build-name=${{ steps.gitversion.outputs.fullSemVer }} \
            --build-number=${{ github.run_number }}

          echo "âœ… Debug APK built successfully using default debug keystore"

      - name: ğŸ“± Get APK info
        id: apk_info
        run: |
          APK_PATH="build/app/outputs/flutter-apk/app-debug.apk"
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
          echo "apk_name=alacarte-v${{ steps.gitversion.outputs.fullSemVer }}-debug.apk" >> $GITHUB_OUTPUT

      - name: ğŸ“ Generate pre-release changelog
        id: changelog
        run: |
          cat << 'EOF' > changelog.md
          ## ğŸ“± Pre-release APK v${{ steps.gitversion.outputs.fullSemVer }}

          **Branch**: `${{ github.head_ref }}`  
          **Base**: `${{ github.event.pull_request.base.ref }}`  
          **Commit**: `${{ github.event.pull_request.head.sha }}`  

          ### ğŸ“¦ APK Information
          - **Size**: ${{ steps.apk_info.outputs.apk_size }}
          - **Build Type**: Debug (development configuration)
          - **Min SDK**: API 24 (Android 7.0)
          - **Target SDK**: API 36

          ### ğŸ“‹ Changes in this PR
          EOF

          # Get commits in this PR
          git log --pretty=format:"* %s" ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} >> changelog.md

          cat << 'EOF' >> changelog.md

          ### ğŸ“± Installation Instructions
          1. Download the APK file below
          2. Enable "Install from Unknown Sources" in Android settings
          3. Install the APK on your Android device
          4. The app will connect to the development API

          ### ğŸ”’ Signing Information
          - **Signing**: Default Android debug keystore (development)
          - **SHA-1**: Automatic debug certificate
          - **Distribution**: For testing only (not for production)

          ### ğŸ”— Links
          - **Source Branch**: [`${{ github.head_ref }}`](${{ github.event.pull_request.html_url }})
          - **API Endpoint**: Development server

          âš ï¸ **This is a pre-release version for testing purposes**
          EOF

      - name: ğŸ‰ Create pre-release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.gitversion.outputs.fullSemVer }}
          name: "ğŸ§ª A la carte Android v${{ steps.gitversion.outputs.fullSemVer }} (Pre-release)"
          body_path: changelog.md
          prerelease: true
          draft: false
          files: |
            ${{ steps.apk_info.outputs.apk_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ’¬ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.gitversion.outputs.fullSemVer }}';
            const apkSize = '${{ steps.apk_info.outputs.apk_size }}';
            
            const body = `## ğŸ“± Pre-release Android APK Ready!
            
            **Version**: \`v${version}\`  
            **Size**: \`${apkSize}\`  
            **Build Type**: Debug (development configuration)
            
            ### ğŸ“¦ Download & Install
            1. Download APK from [GitHub Pre-release](https://github.com/${{ github.repository }}/releases/tag/v${version})
            2. Enable "Install from Unknown Sources" in Android settings
            3. Install the APK on your device
            4. App connects to development API automatically
            
            ### ğŸ”’ Debug Signing
            - Uses **default Android debug keystore**
            - Same SHA-1 as local flutter run builds
            - No custom signing required for development
            
            ### ğŸ”„ Auto-Updates
            > â„¹ï¸ This APK is automatically updated on every push to this PR.
            
            ### ğŸ§ª Testing Notes
            - This is a **debug build** with development configuration
            - Connects to development API endpoint
            - Includes debugging symbols (larger file size)
            - Performance may be slower than release builds`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # Production release job for pushes to master
  release:
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ·ï¸ Install GitVersion
        uses: gittools/actions/gitversion/setup@v0.10.2
        with:
          versionSpec: "5.x"

      - name: ğŸ”¢ Execute GitVersion
        uses: gittools/actions/gitversion/execute@v0.10.2
        id: gitversion

      - name: ğŸ“‹ Display GitVersion outputs
        run: |
          echo "ğŸ“Š GitVersion Results:"
          echo "  â€¢ SemVer: ${{ steps.gitversion.outputs.semVer }}"
          echo "  â€¢ FullSemVer: ${{ steps.gitversion.outputs.fullSemVer }}"
          echo "  â€¢ Major: ${{ steps.gitversion.outputs.major }}"
          echo "  â€¢ Minor: ${{ steps.gitversion.outputs.minor }}"
          echo "  â€¢ Patch: ${{ steps.gitversion.outputs.patch }}"

      - name: ğŸ” Check if version should be released
        id: should_release
        run: |
          # Check if this would create a new version
          CURRENT_VERSION=$(git describe --tags --abbrev=0 2>/dev/null | sed 's/^v//' || echo "0.0.0")
          NEW_VERSION="${{ steps.gitversion.outputs.semVer }}"

          echo "Current version: $CURRENT_VERSION"
          echo "New version: $NEW_VERSION"

          if [ "$NEW_VERSION" != "$CURRENT_VERSION" ]; then
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "ğŸš€ New version detected: $CURRENT_VERSION â†’ $NEW_VERSION"
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No version change detected: $CURRENT_VERSION"
          fi

      - name: ğŸ·ï¸ Create and push Git tag
        if: steps.should_release.outputs.should_release == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a v${{ steps.gitversion.outputs.semVer }} -m "Release v${{ steps.gitversion.outputs.semVer }}"
          git push origin v${{ steps.gitversion.outputs.semVer }}
          echo "âœ… Created and pushed tag v${{ steps.gitversion.outputs.semVer }}"

      - name: ğŸ¦ Setup Flutter
        if: steps.should_release.outputs.should_release == 'true'
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: "stable"

      - name: â˜• Setup Java 17
        if: steps.should_release.outputs.should_release == 'true'
        uses: actions/setup-java@v3
        with:
          distribution: "zulu"
          java-version: "17"

      - name: ğŸ” Setup Android Keystore
        if: steps.should_release.outputs.should_release == 'true'
        run: |
          echo "Setting up Android keystore for release signing..."

          # Decode keystore from base64
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/release-keystore.jks

          # Create key.properties file
          cat << EOF > android/key.properties
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=release-keystore.jks
          EOF

          echo "âœ… Keystore configured for release signing"

      - name: ğŸ”§ Configure for Production
        if: steps.should_release.outputs.should_release == 'true'
        run: |
          echo "ğŸ”§ Creating .env configuration for production..."
          
          # Validate required secrets/variables
          if [ -z "${{ vars.PRODUCTION_API_URL }}" ]; then
            echo "âŒ ERROR: PRODUCTION_API_URL variable is not set"
            echo "Please set this in Repository Settings â†’ Secrets and Variables â†’ Actions â†’ Variables"
            exit 1
          fi
          
          if [ -z "${{ vars.PRODUCTION_GOOGLE_CLIENT_ID }}" ]; then
            echo "âŒ ERROR: PRODUCTION_GOOGLE_CLIENT_ID variable is not set"
            echo "Please set this in Repository Settings â†’ Secrets and Variables â†’ Actions â†’ Variables"
            exit 1
          fi
          
          # Create .env file for production build
          cat << EOF > .env
          # CI/CD Generated .env file for production
          API_BASE_URL=${{ vars.PRODUCTION_API_URL }}
          GOOGLE_CLIENT_ID=${{ vars.PRODUCTION_GOOGLE_CLIENT_ID }}
          APP_VERSION=${{ steps.gitversion.outputs.semVer }}
          EOF
          
          echo "âœ… Created .env file with production configuration"
          echo "ğŸ“‹ .env contents:"
          cat .env

      - name: ğŸ“¦ Get Flutter dependencies
        if: steps.should_release.outputs.should_release == 'true'
        run: flutter pub get

      - name: ğŸŒ Generate localizations
        if: steps.should_release.outputs.should_release == 'true'
        run: flutter gen-l10n

      - name: âœ… Validate Configuration
        if: steps.should_release.outputs.should_release == 'true'
        run: |
          echo "ğŸ“‹ Production Configuration Summary:"
          echo "  â€¢ App Version: ${{ steps.gitversion.outputs.semVer }}"
          echo "  â€¢ Build Number: ${{ github.run_number }}"
          echo "  â€¢ Environment: Release (uses production API)"
          echo ""
          echo "ğŸ” Verifying .env file was created correctly:"
          if [ -f .env ]; then
            echo "  âœ… .env file exists"
            echo "  ğŸ“‹ Contents:"
            cat .env
          else
            echo "  âŒ .env file not found!"
            exit 1
          fi

      - name: ğŸ—ï¸ Build Release APK
        if: steps.should_release.outputs.should_release == 'true'
        run: |
          flutter build apk --release \
            --build-name=${{ steps.gitversion.outputs.semVer }} \
            --build-number=${{ github.run_number }}

      - name: ğŸ“± Get APK info
        if: steps.should_release.outputs.should_release == 'true'
        id: apk_info
        run: |
          APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
          echo "apk_name=alacarte-v${{ steps.gitversion.outputs.semVer }}-release.apk" >> $GITHUB_OUTPUT

      - name: ğŸ“ Generate release changelog
        if: steps.should_release.outputs.should_release == 'true'
        id: changelog
        run: |
          # Get the previous tag for changelog comparison
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          cat << 'EOF' > release_notes.md
          ## ğŸ“± Android APK Information
          - **Size**: ${{ steps.apk_info.outputs.apk_size }}
          - **Build Type**: Release (production configuration)
          - **Min SDK**: API 24 (Android 7.0)
          - **Target SDK**: API 36

          ### ğŸ“¦ Installation Instructions
          1. Download the APK file below
          2. Enable "Install from Unknown Sources" in Android settings if needed
          3. Install the APK on your Android device
          4. The app will connect to the production API

          ### ğŸ”’ Security Notes
          - This APK is signed with our release key
          - Connects to production servers only
          - Optimized for performance and size

          EOF

          if [ -n "$PREVIOUS_TAG" ]; then
            echo "## ğŸ“‹ What's Changed Since $PREVIOUS_TAG" >> release_notes.md
            echo "" >> release_notes.md
            
            # Group commits by type
            echo "### ğŸš€ Features" >> release_notes.md
            git log ${PREVIOUS_TAG}..HEAD --pretty=format:"* %s (%h)" --grep="^feat:" >> release_notes.md 2>/dev/null || echo "_No new features_" >> release_notes.md
            echo "" >> release_notes.md
            echo "" >> release_notes.md
            
            echo "### ğŸ› Bug Fixes" >> release_notes.md
            git log ${PREVIOUS_TAG}..HEAD --pretty=format:"* %s (%h)" --grep="^fix:" >> release_notes.md 2>/dev/null || echo "_No bug fixes_" >> release_notes.md
            echo "" >> release_notes.md
            echo "" >> release_notes.md
            
            echo "### â™»ï¸ Other Changes" >> release_notes.md
            git log ${PREVIOUS_TAG}..HEAD --pretty=format:"* %s (%h)" --invert-grep --grep="^feat:" --grep="^fix:" >> release_notes.md 2>/dev/null || echo "_No other changes_" >> release_notes.md
            echo "" >> release_notes.md
            echo "" >> release_notes.md
            
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...v${{ steps.gitversion.outputs.semVer }}" >> release_notes.md
          else
            echo "## ğŸ‰ Initial Android Release" >> release_notes.md
            echo "" >> release_notes.md
            echo "This is the first Android release of A la carte!" >> release_notes.md
            echo "" >> release_notes.md
            echo "### âœ¨ Features" >> release_notes.md
            git log --pretty=format:"* %s (%h)" >> release_notes.md
          fi

      - name: ğŸ‰ Create GitHub Release
        if: steps.should_release.outputs.should_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.gitversion.outputs.semVer }}
          name: "ğŸš€ A la carte Android v${{ steps.gitversion.outputs.semVer }}"
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            ${{ steps.apk_info.outputs.apk_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“Š Release Summary
        if: steps.should_release.outputs.should_release == 'true'
        run: |
          echo "## ğŸ‰ Android Release Published Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: v${{ steps.gitversion.outputs.semVer }}" >> $GITHUB_STEP_SUMMARY
          echo "**APK Size**: ${{ steps.apk_info.outputs.apk_size }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build Type**: Release (production configuration)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Links**:" >> $GITHUB_STEP_SUMMARY
          echo "- [ğŸ‰ GitHub Release](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.gitversion.outputs.semVer }})" >> $GITHUB_STEP_SUMMARY
          echo "- [ğŸ“± Download APK](https://github.com/${{ github.repository }}/releases/download/v${{ steps.gitversion.outputs.semVer }}/${{ steps.apk_info.outputs.apk_name }})" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“Š No Release Summary
        if: steps.should_release.outputs.should_release != 'true'
        run: |
          echo "## â„¹ï¸ No Android Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No version change detected. Current version: $(git describe --tags --abbrev=0 2>/dev/null || echo 'none')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**To trigger a release, use conventional commits:**" >> $GITHUB_STEP_SUMMARY
          echo "- \`feat: new feature\` â†’ minor version bump" >> $GITHUB_STEP_SUMMARY
          echo "- \`fix: bug fix\` â†’ patch version bump" >> $GITHUB_STEP_SUMMARY
          echo "- \`feat!: breaking change\` â†’ major version bump" >> $GITHUB_STEP_SUMMARY
